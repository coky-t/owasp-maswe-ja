---
title: ユーザーの介入を必要としない共有ストレージに暗号化されずに保存される機密データ (Sensitive Data Stored Unencrypted in Shared Storage Requiring No User Interaction)
id: MASWE-0007
alias: data-unencrypted-shared-storage-no-user-interaction
platform: [android]
profiles: [L1, L2]
mappings:
  masvs-v1: [MSTG-STORAGE-2]
  masvs-v2: [MASVS-STORAGE-1]
  mastg-v1: [MASTG-TEST-0052, MASTG-TEST-0001]
  cwe: [312, 313, 921, 922]
  android-risks:
  - https://developer.android.com/privacy-and-security/risks/sensitive-data-external-storage
status: new
---

## 概要

アプリは、容量が大きいために、外部ストレージにデータを保存することを選択することがよくあります。しかし、この利便性には潜在的なセキュリティ上の欠点を伴います。悪意のあるアプリが重要なパーミッションを付与されると、ユーザーの同意ややり取りなしにいつでもこのデータにアクセスできます。さらに、SD カードなどの外部ストレージは、悪意のある人物により物理的に取り外され、読み取られる可能性があります。たとえ外部ストレージがシステムによってエミュレートされていたとしても、不適切なファイルパーミッションやファイル保存用の API の誤用によってリスクが生じます。そのような場合、ファイルは不正アクセス、改変、削除に対して脆弱になり、アプリケーションにとってセキュリティ脅威となります。

開発者は、より高いプライバシーとセキュリティを必要とする場合、プライベートストレージやユーザーインタラクションを必要とする共有ストレージへの切り替えを検討できます。しかし、外部ストレージがアプリにとって最適である場合には、外部ストレージに保存するデータを暗号化することをお勧めします。以下では、外部ストレージの使用に関連する潜在的なセキュリティへの影響と緩和策を見出します。

## 影響

- **機密性の喪失**: 攻撃者は、個人情報や、写真、ドキュメント、音声ファイルなどのメディアなど、外部に保存される機密データを抽出できます。

- **安全なマテリアルの喪失**: 攻撃者はパスワード、暗号鍵、セッショントークンを抽出して、なりすましやアカウント乗っ取りなど、追加の攻撃を容易にすることができます。

- **アプリの動作の改変**: 攻撃者はアプリで使用されるデータを改竄し、アプリのロジックを改変する可能性があります。たとえば、プレミアム機能の状態を記述するようにデータベースを改変したり、悪意のあるペイロードを注入して SQL インジェクションやパストラバーサルなどのさらなる攻撃を有効にする可能性があります。

- **ダウンロードされたコードの改変**: アプリはインターネットから新しい機能をダウンロードし、実行コードをプロセス内にロードする前に外部ストレージに保存できます。攻撃者はこのコードがアプリによって使用される前に改変できます。

## 流入の形態

この脅威は主に外部ストレージの使用を許可する Android デバイスにとっての懸念事項です。デバイスに物理的な外部ストレージがない場合でも、Android はそれをエミュレートして外部ストレージ API へのアクセスを提供します。

- **暗号化なしで保存されたデータ**: 機密データは暗号化なしで外部ストレージに保存されます。
- **ハードコードされた暗号鍵**: 機密データは暗号化されて外部ストレージに保存されますが、鍵はアプリケーション内にハードコードされています。
- **ファイルシステムに保存された暗号鍵**: 機密データは暗号化されて外部ストレージに保存されますが、鍵は近くまたは簡単にアクセスできる別の場所に保存されています。
- **使用される暗号が不十分**: 機密データは暗号化されますが、暗号は強力とはいえません。
- **暗号鍵の再使用**: 暗号鍵は一人のユーザーが所有する二台のデバイス間で共有され、デバイス間で外部ストレージにデータ複製するプロセスを有効にします。

iOS では、デスクトップオペレーティングシステムや Android とは異なり、アプリは任意の場所に直接書き込みや読み込みをできません。iOS は厳格なサンドボックスルールを維持しており、アプリは自身のサンドボックス化されたファイルディレクトリのみにアクセスできることを意味します。

## 緩和策

外部ストレージに保存される機密データは暗号化する必要があり、利用可能な場合、データ暗号化に使用される鍵はデバイスのハードウェア基盤のキーストアで保護する必要があります。アプリケーション内に暗号鍵をハードコードすることは、絶対に阻止します。また、ファイルを [プライベートアプリサンドボックスまたは内部ストレージ](https://developer.android.com/training/data-storage/app-specific#internal) に保存し、[Android のファイル暗号化用の EncryptedFile API ラッパー](https://developer.android.com/reference/androidx/security/crypto/EncryptedFile) を使用することも検討できます。

> [!WARNING]
>
> `EncryptedFile` クラスと `EncryptedSharedPreferences` クラスを含む **Jetpack Security Crypto ライブラリ** は [非推奨](https://developer.android.com/privacy-and-security/cryptography#jetpack_security_crypto_library) になりました。ただし、公式の代替品はまだリリースされていないため、それが利用可能になるまではこれらのクラスを使用することをお勧めします。
