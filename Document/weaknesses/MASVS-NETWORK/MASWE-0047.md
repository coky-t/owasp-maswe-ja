---
title: 安全でないアイデンティティのピン留め (Insecure Identity Pinning)
id: MASWE-0047
alias: insecure-pinning
platform: [android, ios]
profiles: [L2]
mappings:
  masvs-v1: [MSTG-NETWORK-4]
  masvs-v2: [MASVS-NETWORK-2]
  cwe: [295]
status: new
---

## 概要

[アイデンティティピン留め (別名、証明書ピン留め、公開鍵ピン留め、TLS ピン留め)](https://github.com/coky-t/owasp-mastg-ja/blob/master/Document/0x04f-Testing-Network-Communication.md#restricting-trust-identity-pinning) は、モバイルアプリを証明書や公開鍵などの特定の暗号アイデンティティに関連付け、アプリが信頼できるサーバーとのみ通信するように確保することを指します。

モバイルアプリが証明書ピン留めを実装しない場合、または正しく実装されていない場合、アプリは [中間マシン (MITM)](https://github.com/coky-t/owasp-mastg-ja/blob/master/Document/0x04f-Testing-Network-Communication.md#intercepting-network-traffic-through-mitm) 攻撃に脆弱なままとなり、攻撃者はアプリと意図したサーバー間の通信を傍受して改変することができます。これは、アプリが不正な証明書を提示され、アプリがそれを知らないうちに信頼してしまう場合に発生し、それによって機密データにアクセスしたり、データストリームに悪意のあるコンテンツを注入する可能性があります。

**制限事項**: 証明書ピン留めは、アプリが特定の事前定義された証明書または公開鍵を持つサーバーへの接続のみを受け入れるようにすることで、信頼性の検証レイヤを追加します。これは、信頼できる証明機関 (CA) が侵害された場合でも、不正な傍受のリスクを軽減します。ただし、これは確実ではありません。

- アプリをリバースエンジニアできる攻撃者は、事前定義された PIN や証明書ピン留めロジックを解析し、削除または改変して、そのチェックを恒久的にバイパスします。
- [改竄と実行時計装 (Tampering and Runtime Instrumentation)](https://github.com/coky-t/owasp-mastg-ja/blob/master/techniques/generic/MASTG-TECH-0051.md) 技法を実行できる攻撃者は、アプリを操作してピン留めチェックをバイパスします。

これは、高度な教に対するアプリの耐性を強化するために、**他のセキュリティ対策と併せて** 証明書ピン留めを実装することの重要性を浮き彫りにしています。

## 影響

- **データ傍受**: 攻撃者はネットワーク経由で送信される機密情報を捕捉して読み取ることができます。
- **データ操作**: 攻撃者は転送時のデータを改変し、破損を引き起こしたり、悪意のあるコンテンツを注入する可能性があります。
- **データ露出**: 機密情報が侵害される可能性があります。
- **サービス拒否**: 不正確なピン留めは正当な接続が失敗し、ユーザーへのサービス中断につながる可能性があります。たとえば、ピン留めされた証明書が有効期限切れして更新されていない場合、アプリは安全な接続を確立できない可能性があります。

## 流入の形態

- **ピン留めライブラリの不適切な構成**: TrustKit、OkHttp の `CertificatePinner`、Volley、AFNetworking の `SSLPinningMode` などのライブラリを構成ミスして、効果のないピン留めにつながります。
- **セキュリティなしでの動的なピン留め**: 適切なバリデーションなしで安全でないチャネル経由で動的にピンを取得することで、攻撃者が悪意のあるピンを容易に提供できるようになります。
- **不適切なバリデーションロジック**: 証明書チェーンや公開鍵を正しく検証しないカスタムピン留め実装。たとえば、特定の証明書や公開鍵ではなく、信頼されているルート CA にチェーンしている証明書をすべて受け入れます。
- **バックアップピンの欠如**: プライマリピンが有効ではなくなった場合に接続の問題を防ぐためのバックアップピンを含めていません。

## 緩和策

- **プラットフォーム提供のソリューションを優先する**: Android の Network Security Configuration (NSC) や iOS の App Transport Security (ATS) などのプラットフォーム提供のメカニズムを使用して、ピン留めを強制します。
- **信頼できるピン留めライブラリを使用する**: カスタムのピン留めロジックを作成することは控え、代わりに、確立され十分に保守されているライブラリやフレームワーク (TrustKit, OkHttp の `CertificatePinner` など) に依存し、ベストプラクティスに従って正しく構成されることを確保します。
- **安全な動的ピン留め**: 動的ピン留めが必要な場合、安全なチャネル経由でピンを取得し、使用前に徹底的に検証します。
- **証明書ではなく公開鍵をピン留めする**: 証明書全体ではなく証明書の公開鍵をピン留めし、有効期限切れや更新に関する問題を避けます。
- **一貫した適用**: 制御するサーバーへのすべての接続に一様にピン留めを適用します。
- **ピンを定期的に更新する**: ピン留めされた証明書や公開鍵をサーバーの現在の構成に合わせて最新に保ち、変更が発生した際にアプリを更新するプロセスを用意します。
- **バックアップピンを実装する**: バックアップピン (追加の信頼できる公開鍵のハッシュ) を含めて、プライマリ鍵が変更した際に接続の問題を防ぎます。
